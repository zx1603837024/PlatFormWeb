@using P4.Web.Models
@model IndexModel
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = L("ParkingIndex");
    ViewBag.ActiveMenu = "ParkingIndex";
}

<div class="row">
    <div class="space-6"></div>
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <div class="dashboard-stat blue-madison">
            <div class="visual">
                <i class="fa fa-comments"></i>
            </div>
            <div class="details">
                <div class="number" id="TodayMoney">
                    @Model.TodayMoney
                </div>
                <div class="desc">
                    今日所收金额
                </div>
            </div>
            <a class="more" href="~/Business/BusinessDetails">
                查看更多 <i class="m-icon-swapright m-icon-white"></i>
            </a>
        </div>
    </div>

    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <div class="dashboard-stat green-haze">
            <div class="visual">
                <i class="fa fa-bar-chart-o"></i>
            </div>
            <div class="details">
                <div class="number" id="MonthMoney">
                    @Model.MonthMoney
                </div>
                <div class="desc">
                    当月所收金额
                </div>
            </div>
            <a class="more" href="~/Business/BusinessDetails">
                查看更多 <i class="m-icon-swapright m-icon-white"></i>
            </a>
        </div>
    </div>

    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <div class="dashboard-stat red-intense">
            <div class="visual">
                <i class="fa fa-shopping-cart"></i>
            </div>
            <div class="details">
                <div class="number" id="TodayOrderSize">
                    @Model.TodayOrderSize
                </div>
                <div class="desc">
                    当日订单量
                </div>
            </div>
            <a class="more" href="~/Business/EscapeDetails">
                查看更多 <i class="m-icon-swapright m-icon-white"></i>
            </a>
        </div>
    </div>

    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <div class="dashboard-stat purple-plum">
            <div class="visual">
                <i class="fa fa-globe"></i>
            </div>
            <div class="details">
                <div class="number" id="MonthOrderSize">
                    @Model.MonthOrderSize
                </div>
                <div class="desc">
                    当月订单量
                </div>
            </div>
            <a class="more" href="~/Business/EscapeDetails">
                查看更多<i class="m-icon-swapright m-icon-white"></i>
            </a>
        </div>
    </div>

    <div class="space-6"></div>

    <div class="col-sm-7 infobox-container">
        @*第一行*@
        <div class="infobox infobox-blue  ">
            <div class="infobox-icon">
                <i class="icon-shopping-cart"></i>
            </div>
            <div class="infobox-data">
                <span class="infobox-data-number">@(Model.MonthCarChain.MonthCarNowCount)</span>
                <div class="infobox-content">包月数量</div>
            </div>
            @if (Model.MonthCarChain.CountPercentUp != null)
            {
                <div class="badge badge-success">
                    @(Model.MonthCarChain.CountPercentUp)
                    %<i class="icon-arrow-up"></i>
                </div>
            }
            else
            {
                <div class="stat stat-important">@(Model.MonthCarChain.CountPercentDown)%</div>
            }
        </div>

        <div class="infobox infobox-pink  ">
            <div class="infobox-icon">
                <i class="icon-shopping-cart"></i>
            </div>

            <div class="infobox-data">
                <span class="infobox-data-number">@(Model.MonthCarChain.MonthCarNowMoney)</span>
                <div class="infobox-content">
                    包月车辆金额
                </div>
            </div>
            @if (Model.MonthCarChain.MoneyPercentUp != null)
            {
                <div class="badge badge-success">
                    @(Model.MonthCarChain.MoneyPercentUp)
                    %<i class="icon-arrow-up"></i>
                </div>
            }
            else
            {
                <div class="stat stat-important">@(Model.MonthCarChain.MoneyPercentDown)%</div>
            }
        </div>

        <div class="infobox infobox-red  ">
            <div class="infobox-icon">
                <i class="icon-shopping-cart"></i>
            </div>

            <div class="infobox-data">
                <span class="infobox-data-number">@(Model.MonthCarChain.MonthCarTotalMoney)</span>
                <div class="infobox-content">包月车辆总金额</div>
            </div>
        </div>
        @*第一行*@

        @*第二行*@
        <div class="infobox infobox-red  " id="fact">
            <div class="infobox-progress">
                <div class="easy-pie-chart percentage" data-percent="61" data-size="39">
                    <span class="percent">@(Model.SensorCount.SensorCount == 0 ? 0 : ((Model.SensorCount.SensorOnLineCount * 100) / Model.SensorCount.SensorCount))</span>%
                </div>
            </div>

            <div class="infobox-data">
                <span class="infobox-text">车检器在线率</span>
                <div class="infobox-content">
                    @Model.SensorCount.SensorOnLineCount/ @Model.SensorCount.SensorCount
                </div>
            </div>
        </div>
        <div class="infobox infobox-red  " id="fact">
            <div class="infobox-progress">
                <div class="easy-pie-chart percentage" data-percent="61" data-size="39">
                    <span class="percent">@(Model.WeixinCount.NewRegisterCount == 0 ? 0 : ((Model.WeixinCount.NewRegisterCount * 100) / Model.WeixinCount.AllRegisterCount))</span>%
                </div>
            </div>

            <div class="infobox-data">
                <span class="infobox-text">注册用户</span>
                <div class="infobox-content">
                    @Model.WeixinCount.NewRegisterCount/ @Model.WeixinCount.AllRegisterCount
                </div>
            </div>
        </div>
        <div class="infobox infobox-orange2  ">
            <div class="infobox-progress">
                <div class="easy-pie-chart percentage" data-percent="61" data-size="39">
                    <span class="percent">@(Model.SignoCount.SignoCount == 0 ? 0 : Math.Round(Model.SignoCount.SignoOnLineCount / (double)Model.SignoCount.SignoCount * 100, 0))</span>%
                </div>
            </div>

            <div class="infobox-data">
                <span class="infobox-text">道闸在线率</span>

                <div class="infobox-content">
                    @Model.SignoCount.SignoOnLineCount/@Model.SignoCount.SignoCount
                </div>
            </div>
        </div>
        @*第二行*@

        @*第三行*@
        <div class="infobox infobox-blue2  ">

            <div class="infobox-progress">
                <div class="easy-pie-chart percentage" data-percent="61" data-size="39">
                    <span class="percent">@(Model.BerthsecCount.FactReceive == 0 ? 0 : Math.Round(Model.BerthsecCount.Cash / Model.BerthsecCount.FactReceive * 100, 0))</span>%
                </div>
            </div>
            <div class="infobox-data">
                <span class="infobox-text">现金支付率</span>

                <div class="infobox-content">
                    @Model.BerthsecCount.Cash/@Model.BerthsecCount.FactReceive
                </div>
            </div>
        </div>
        <div class="infobox infobox-blue  " id="employeecheck">
            <div class="infobox-progress">
                <div class="easy-pie-chart percentage" data-percent="61" data-size="39">
                    <span class="percent">@(Model.CheckTotal.Count == 0 ? 0 : Math.Round(Model.CheckTotal.CheckInCout / (double)Model.CheckTotal.Count * 100, 0))</span>%
                </div>
            </div>

            <div class="infobox-data">
                <span class="infobox-text">收费员签到</span>

                <div class="infobox-content">
                    @Model.CheckTotal.CheckInCout / @Model.CheckTotal.Count
                </div>
            </div>
        </div>
        <div class="infobox infobox-green  ">
            <div class="infobox-progress">
                <div class="easy-pie-chart percentage" data-percent="61" data-size="39">
                    <span class="percent">@(Model.CheckTotal.Count == 0 ? 0 : Math.Round(Model.CheckTotal.CheckOutCount / (double)Model.CheckTotal.Count * 100, 0))</span>%
                </div>
            </div>
            <div class="infobox-data">
                <span class="infobox-text">收费员签退</span>

                <div class="infobox-content">
                    @Model.CheckTotal.CheckOutCount / @Model.CheckTotal.Count
                </div>
            </div>
        </div>
        @*第三行*@
        </div>


        <div class="vspace-sm"></div>

        <div class="col-sm-5">
            <div class="widget-box">
                <div class="widget-header widget-header-flat widget-header-small">
                    <h5>
                        <i class="icon-signal"></i>
                        收费金额饼状图
                    </h5>

                    <div class="widget-toolbar no-border">
                        <button class="btn btn-minier btn-primary dropdown-toggle" data-toggle="dropdown">
                            @*本周*@
                            今天
                            <i class="icon-angle-down icon-on-right bigger-110"></i>
                        </button>

                    </div>
                </div>

                <div class="widget-body">
                    <div class="widget-main">
                        <div id="piechart-placeholder"></div>

                        <div class="hr hr8 hr-double"></div>

                        <div class="clearfix">
                            <div class="grid3">
                                <span class="grey">
                                    &nbsp; 应收
                                </span>
                                <h4 class="bigger pull-right">@Model.BerthsecCount.Receivable</h4>
                            </div>

                            <div class="grid3">
                                <span class="grey">
                                    &nbsp; 实收
                                </span>
                                <h4 class="bigger pull-right">@Model.BerthsecCount.FactReceive</h4>
                            </div>

                            <div class="grid3">
                                <span class="grey">
                                    &nbsp; 追缴
                                </span>
                                <h4 class="bigger pull-right">@Model.BerthsecCount.Repayment</h4>
                            </div>
                        </div>
                    </div><!-- /widget-main -->
                </div><!-- /widget-body -->
            </div><!-- /widget-box -->
        </div><!-- /span -->
    </div><!-- /row -->

<div class="hr hr32 hr-dotted"></div>

<div class="row">
    <div class="col-sm-5">
        <div class="widget-box transparent">
            <div class="widget-header widget-header-flat">
                <h4 class="lighter">
                    <i class="icon-star orange"></i>
                    <a href="../Decision/PeakPeriod">高峰预警</a>
                </h4>

                <div class="widget-toolbar">
                    <a href="#" data-action="collapse">
                        <i class="icon-chevron-up"></i>
                    </a>
                </div>
            </div>

            <div class="widget-body">
                <div class="widget-main no-padding">
                    <table class="table table-bordered table-striped">
                        <thead class="thin-border-bottom">
                            <tr>
                                <th>
                                    <i class="icon-caret-right blue"></i>
                                    预警事件
                                </th>

                                <th>
                                    <i class="icon-caret-right blue"></i>
                                    预警时间
                                </th>

                                <th class="hidden-480">
                                    <i class="icon-caret-right blue"></i>
                                    状态
                                </th>
                            </tr>
                        </thead>

                        <tbody>
                            @if (Model.PeakPeriodList.Count > 0)
                            {
                                foreach (var e in Model.PeakPeriodList)
                                {
                                    <tr>
                                        <td>
                                            <b class="green">@e.Remark</b>
                                        </td>
                                        <td>
                                            <b class="yellow">@e.BeginTime</b>
                                        </td>
                                        <td class="center"><span class='badge badge-@(e.IsActive == true ? "success" : "warning")'>@(e.IsActive == true ? "已结束" : "未结束")</span></td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="3" class="center">
                                        <p>无数据</p>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div><!-- /widget-main -->
            </div><!-- /widget-body -->
        </div><!-- /widget-box -->
    </div>

    <div class="col-sm-7">
        <div class="widget-box transparent">
            <div class="widget-header widget-header-flat">
                <h4 class="lighter">
                    <i class="icon-signal"></i>
                    月收费统计
                </h4>

                <div class="widget-toolbar">
                    <a href="#" data-action="collapse">
                        <i class="icon-chevron-up"></i>
                    </a>
                </div>
            </div>

            <div class="widget-body">
                <div class="widget-main padding-4">
                    <div id="sales-charts"></div>
                </div><!-- /widget-main -->
            </div><!-- /widget-body -->
        </div><!-- /widget-box -->
    </div>
</div>

<div class="hr hr32 hr-dotted"></div>

<div class="row">
    <div class="col-sm-6">
        <div class="widget-box transparent" id="recent-box">
            <div class="widget-header">
                <h4 class="lighter smaller">
                    <i class="icon-rss orange"></i>
                    管理
                </h4>

                <div class="widget-toolbar no-border">
                    <ul class="nav nav-tabs" id="recent-tab">
     
                        <li class="active">
                            <a data-toggle="tab" href="#comment-tab">用户反馈投诉</a>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="widget-body">
                <div class="widget-main padding-4">
                    <div class="tab-content padding-8 overflow-visible">
                        <div id="comment-tab" class="tab-pane">
                            <div class="comments">

                                @foreach (var weixinidea in Model.WeixinIdeas)
                                {
                                    <div class="itemdiv commentdiv">

                                        <div class="body">
                                            <div class="name">
                                                <a href="#">@weixinidea.account</a>
                                            </div>

                                            <div class="time">
                                                <i class="icon-time"></i>
                                                <span class="blue">@weixinidea.createTimeStr</span>
                                            </div>

                                            <div class="text">
                                                <i class="icon-quote-left"></i>
                                                @weixinidea.context &hellip;
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>

                            <div class="hr hr8"></div>

                            <div class="center">
                                <i class="icon-comments-alt icon-2x green"></i>
                                &nbsp;
                                <a href="~/Weixin/WeixinIdea">
                                    查看所有反馈投诉 &nbsp;
                                    <i class="icon-arrow-right"></i>
                                </a>
                            </div>

                            <div class="hr hr-double hr8"></div>
                        </div>
                    </div>
                </div><!-- /widget-main -->
            </div><!-- /widget-body -->
        </div><!-- /widget-box -->
    </div><!-- /span -->


    <div class="col-sm-6">
        <div class="widget-box transparent">
            <div class="widget-header widget-header-flat">
                <h4 class="lighter">
                    <i class="icon-star orange"></i>
                    收费员收费列表
                </h4>

                <div class="widget-toolbar">
                    <a href="#" data-action="collapse">
                        <i class="icon-chevron-up"></i>
                    </a>
                </div>
            </div>

            <div class="widget-body">
                <div class="widget-main no-padding">
                    <table class="table table-bordered table-striped">
                        <thead class="thin-border-bottom">
                            <tr>
                                <th>
                                    <i class="icon-caret-right blue"></i>
                                    姓名
                                </th>

                                <th>
                                    <i class="icon-caret-right blue"></i>
                                    收费金额
                                </th>

                                <th class="hidden-480">
                                    <i class="icon-caret-right blue"></i>
                                    状态
                                </th>
                            </tr>
                        </thead>

                        <tbody>
                            @if (Model.EmployeeCountList.Count > 0)
                            {
                                foreach (var e in Model.EmployeeCountList)
                                {
                                    <tr>
                                        <td>@e.EmployeeName</td>

                                        <td>
                                            <b class="green">@e.FactReceive</b>
                                        </td>

                                        <td class="hidden-480">
                                            @if (e.FactReceive >= 500)
                                            {
                                                <span class="label label-info arrowed-right arrowed-in">超额</span>
                                            }
                                            else if (e.FactReceive < 300)
                                            {
                                                <span class="label label-info arrowed-right arrowed-in">未达标</span>
                                            }
                                            else
                                            {
                                                <span class="label label-info arrowed-right arrowed-in">达标</span>
                                            }

                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="3" class="center">
                                        <p>无数据</p>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div><!-- /widget-main -->
            </div><!-- /widget-body -->
        </div><!-- /widget-box -->
    </div>

</div><!-- /row -->

@section scriptsindex
{
    <script src="../../assets/js/jquery-ui-1.10.3.custom.min.js"></script>
    <script src="../../assets/js/jquery.ui.touch-punch.min.js"></script>
    <script src="../../assets/js/jquery.slimscroll.min.js"></script>
    <script src="../../assets/js/jquery.easy-pie-chart.min.js"></script>
    <script src="../../assets/js/jquery.sparkline.min.js"></script>
    <script src="../../assets/js/flot/jquery.flot.min.js"></script>
    <script src="../../assets/js/flot/jquery.flot.pie.min.js"></script>
    <script src="../../assets/js/flot/jquery.flot.resize.min.js"></script>
}

@section styles
{
    <link href="~/assets/css/components-rounded.css" rel="stylesheet" />
}

@section scripts
{
    <script type="text/javascript">
        jQuery(function ($) {
            $('.easy-pie-chart.percentage').each(function () {
                var $box = $(this).closest('.infobox');
                var barColor = $(this).data('color') || (!$box.hasClass('infobox-dark') ? $box.css('color') : 'rgba(255,255,255,0.95)');
                var trackColor = barColor == 'rgba(255,255,255,0.95)' ? 'rgba(255,255,255,0.25)' : '#E2E2E2';
                var size = parseInt($(this).data('size')) || 50;
                $(this).easyPieChart({
                    barColor: barColor,
                    trackColor: trackColor,
                    scaleColor: false,
                    lineCap: 'butt',
                    lineWidth: parseInt(size / 10),
                    animate: /msie\s*(8|7|6)/.test(navigator.userAgent.toLowerCase()) ? false : 1000,
                    size: size
                });
            })

            $('.sparkline').each(function () {
                var $box = $(this).closest('.infobox');
                var barColor = !$box.hasClass('infobox-dark') ? $box.css('color') : '#FFF';
                $(this).sparkline('html', { tagValuesAttribute: 'data-values', type: 'bar', barColor: barColor, chartRangeMin: $(this).data('min') || 0 });
            });




            var placeholder = $('#piechart-placeholder').css({ 'width': '90%', 'min-height': '150px' });

            var parklist = eval('@Html.Raw(Model.ParkTotalListJson)');
            var dataArray = new Array();

            $.each(parklist, function (i, item) {
                var dataobject = new Object();
                dataobject.label = item.ParkName.toString();
                dataobject.data = item.FactReceive;
                dataArray.push(dataobject);
            });
            var data = eval(JSON.stringify(dataArray));

            function drawPieChart(placeholder, data, position) {
                $.plot(placeholder, data, {
                    series: {
                        pie: {
                            show: true,
                            tilt: 0.8,
                            highlight: {
                                opacity: 0.25
                            },
                            stroke: {
                                color: '#fff',
                                width: 2
                            },
                            startAngle: 2
                        }
                    },
                    legend: {
                        show: true,
                        position: position || "ne",
                        labelBoxBorderColor: null,
                        margin: [-30, 15]
                    },
                    grid: {
                        hoverable: true,
                        clickable: true
                    }
                })
            }
            drawPieChart(placeholder, data);


            /**
            we saved the drawing function and the data to redraw with different position later when switching to RTL mode dynamically
            so that's not needed actually.
            */
            placeholder.data('chart', data);
            placeholder.data('draw', drawPieChart);



            var $tooltip = $("<div class='tooltip top in'><div class='tooltip-inner'></div></div>").hide().appendTo('body');
            var previousPoint = null;

            placeholder.on('plothover', function (event, pos, item) {
                if (item) {
                    if (previousPoint != item.seriesIndex) {
                        previousPoint = item.seriesIndex;
                        var tip = item.series['label'] + " : " + item.series['data'][0][1] + '元  (' +  item.series['percent'].toFixed(2)+ '%)';
                        $tooltip.show().children(0).text(tip);
                    }
                    $tooltip.css({ top: pos.pageY + 10, left: pos.pageX + 10 });
                } else {
                    $tooltip.hide();
                    previousPoint = null;
                }
            });


            var monthlist = eval('@Html.Raw(Model.MonthTotalListJson)');

            var d1 = [];
            var d2 = [];
            var d3 = [];
            $.each(monthlist, function (i, item) {
                d1.push([item.monthday, item.Receivable]);
                d2.push([item.monthday, item.FactReceive]);
                d3.push([item.monthday, item.Arrearage]);
            });

            var sales_charts = $('#sales-charts').css({ 'width': '100%', 'height': '220px' });
            $.plot("#sales-charts", [
                { label: "应收", data: d1 },
                { label: "实收", data: d2 },
                { label: "欠费", data: d3 }
            ], {
                hoverable: true,
                shadowSize: 0,
                series: {
                    lines: { show: true },
                    points: { show: true }
                },
                xaxis: {
                    //tickLength: 0,
                    ticks: d1[d1.length - 1][0],
                    min: 0,
                    max: d1[d1.length - 1][0],
                    tickDecimals: 0

                },
                yaxis: {
                    ticks: 10,
                    min: 0,
                    max: d1[0][1] + 4000,
                    tickDecimals: 2
                },
                grid: {
                    backgroundColor: { colors: ["#fff", "#fff"] },
                    borderWidth: 1,
                    borderColor: '#555'
                }
            });


            $('#recent-box [data-rel="tooltip"]').tooltip({ placement: tooltip_placement });
            function tooltip_placement(context, source) {
                var $source = $(source);
                var $parent = $source.closest('.tab-content')
                var off1 = $parent.offset();
                var w1 = $parent.width();

                var off2 = $source.offset();
                var w2 = $source.width();

                if (parseInt(off2.left) < parseInt(off1.left) + parseInt(w1 / 2)) return 'right';
                return 'left';
            }


            $('.dialogs,.comments').slimScroll({
                height: '300px'
            });
            var agent = navigator.userAgent.toLowerCase();
            if ("ontouchstart" in document && /applewebkit/.test(agent) && /android/.test(agent))
                $('#tasks').on('touchstart', function (e) {
                    var li = $(e.target).closest('#tasks li');
                    if (li.length == 0) return;
                    var label = li.find('label.inline').get(0);
                    if (label == e.target || $.contains(label, e.target)) e.stopImmediatePropagation();
                });

            $('#tasks').sortable({
                opacity: 0.8,
                revert: true,
                forceHelperSize: true,
                placeholder: 'draggable-placeholder',
                forcePlaceholderSize: true,
                tolerance: 'pointer',
                stop: function (event, ui) {
                    $(ui.item).css('z-index', 'auto');
                }
            });
            $('#tasks').disableSelection();
            $('#tasks input:checkbox').removeAttr('checked').on('click', function () {
                if (this.checked) $(this).closest('li').addClass('selected');
                else $(this).closest('li').removeClass('selected');
            });
        });
        function LoadUltimo() {

        }
        $('#fact').click(function () {
            window.location.href = "../Weixin/WeixinTUser";
        });

        $('#employeecheck').click(function () {
            window.location.href = "../logging/employeelog";
        });

        //数字读数效果
        function countUp(elem, endVal, startVal, duration, decimal) {
            var startTime = 0;
            var dec = Math.pow(10, decimal);
            var progress, value;
            function startCount(timestamp) {
                startTime = !startTime ? timestamp : startTime;
                progress = timestamp - startTime;
                value = startVal + (endVal - startVal) * (progress / duration);
                value = (value > endVal) ? endVal : value;
                value = Math.floor(value * dec) / dec;
                elem.innerHTML = value.toFixed(decimal);
                progress < duration && requestAnimationFrame(startCount)
            }
            requestAnimationFrame(startCount)
        }
        //countUp(document.getElementById('Receivable'), document.getElementById('Receivable').innerHTML, 0, 2000, 2);

        //countUp(document.getElementById('FactReceive'), document.getElementById('FactReceive').innerHTML, 0, 2000, 2);

        //countUp(document.getElementById('Arrearage'), document.getElementById('Arrearage').innerHTML, 0, 2000, 2);

        //countUp(document.getElementById('Repayment'), document.getElementById('Repayment').innerHTML, 0, 2000, 2);


    </script>
}

